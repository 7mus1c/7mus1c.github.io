# Monorepo

## monorepo 和 multirepo

- Monorepo 是将多个项目放在一个代码仓库中，而 Multirepo 是将多个项目放在多个代码仓库中。
- Monorepo 可以更方便地管理和协作，因为它将所有代码放在一个地方，可以更容易地共享代码和依赖关系。

monorepo 项目结构

```bash
monorepo-project/
├── packages/
│   ├── shared-ui/      # UI 组件库
│   ├── shared-utils/   # 工具函数库
│   ├── web-app/        # Web 应用
│   ├── mobile-app/     # 移动端应用
│   └── admin-panel/    # 管理后台
├── apps/
│   ├── docs/           # 文档站点
│   └── playground/     # 开发调试
├── tools/
│   ├── build-scripts/  # 构建脚本
│   └── eslint-config/  # 共享配置
└── package.json
```

## multirepo 的痛点

1. 代码复用：多个项目需要相同的工具函数、UI 组件等，需要在每个项目中重复编写。修改一个样式，需要同步多个仓库。
2. 版本管理：项目 A`@company/utils: 2.1.5`，项目 B`@company/utils: ^1.1.0`，版本严重不一致，兼容问题难以追踪，需要手动维护版本。
3. 开发调试：A 项目是 B 项目的依赖。A 每次修改后手动运行多个命令，B 手动更新修改。然后再次开始调试。循环如此！
4. 跨项目难：一个功能涉及了多个项目，需要手动在多个项目中修改，然后手动运行多个命令，最后手动合并多个项目的结果。
5. 依赖管理：每个项目都有自己的依赖管理，依赖版本不一致，导致兼容性问题。
6. 工具链：每个项目都需要单独配置工具链，如构建工具、测试框架、代码规范等，维护成本高。而且往往几个项目都工具链一模一样。
7. CI/CD：每个项目都需要单独配置 CI/CD，维护成本高。而且还有可能每个项目的构建工具不统一。
8. 权限访问：每个项目都需要单独配置权限访问，维护成本高。而且往往几个项目权限配置一模一样。
9. 知识共享：相同的解决方案，在不同的项目中重复编写，导致知识共享困难。

### 成本问题

**基础设施成本**：

1. Git 仓库
2. CI/CD 流水线
3. NPM 包发布配置
4. 文档站点
5. 监控和告警

**人力成本**：

1. 跨团队协调会议
2. 重复相同的问题
3. 维护多个版本的文档
4. 培训新成员了解多个项目结构

总的来说：

1. 协作壁垒 - 团队和项目间存在人为隔阂
2. 效率瓶颈 - 重复工作和复杂流程拖慢开发速度
3. 质量风险 - 不一致的标准和难以追踪的依赖关系
4. 成本膨胀 - 基础设施和人力成本随项目数量线性增长
5. 创新阻力 - 跨项目更改的高成本抑制了架构演进

## monorepo 的优势

以上问题都可以通过 monorepo 来解决。

```bash
company/
├── web-app/           # 主站 (React 18)
├── mobile-app/        # 移动端 (React Native)
├── admin-panel/       # 后台 (Vue 3)
├── shared-utils/      # 工具库
├── ui-components/     # UI 组件
├── api-client/        # API 客户端
└── design-system/     # 设计系统

# 问题：
# - 12个独立仓库
# - 3种不同的框架
# - 5个不同的构建工具
# - 跨团队更改需要2-3周协调


# 从 Multirepo 迁移到 Monorepo
company-monorepo/
├── apps/
│   ├── web-app/
│   ├── mobile-app/
│   └── admin-panel/
├── packages/
│   ├── utils/
│   ├── ui/
│   ├── api-client/
│   └── design-system/
├── tools/           # 共享工具链
└── package.json     # 统一依赖管理
```

### 优势

| 痛点领域 | Multirepo           | Monorepo            |
| -------- | ------------------- | ------------------- |
| 代码共享 | ❌ 困难，需要发布包 | ✅ 直接源码引用     |
| 依赖管理 | ❌ 版本碎片化       | ✅ 统一版本         |
| 开发体验 | ❌ 跨项目调试复杂   | ✅ 一站式开发       |
| CI/CD    | ❌ 配置重复         | ✅ 统一配置         |
| 代码质量 | ❌ 标准不一致       | ✅ 统一规范         |
| 团队协作 | ❌ 权限复杂         | ✅ 简化协作         |
| 重构成本 | ❌ 高昂，需要协调   | ✅ 低成本，原子提交 |

## 使用场景

1. 组件库
2. 微前端架构
3. 全栈项目

## 不适合场景

1. 独立的项目，如博客、游戏平台、电商网站，这些没有意义不建议放在一起。
2. 不同技术栈的项目，如一个项目用 React，另一个项目用 Vue，这些项目放在一起，反而会增加维护成本。
3. 大型团队有严格的权限管理，每个团队只能访问自己的项目，不建议放在一起。

## 搭建 Monorepo 项目

- 小型项目： pnpm workspace
- 中型项目：pnpm + Turborepo 加速构建
- 大型项目：pnpm + Nx 提供更多功能

### pnpm workspace

1. 初始化项目

```bash
mkdir my-monorepo && cd my-monorepo

pnpm init
```

2. 创建目录

```bash
my-monorepo/
├── apps/
│   ├── web/
│   └── admin/
├── packages/
│   ├── utils/
│   ├── ui/
│   └── types/
├── tools/           # 共享工具链
└── package.json
```
