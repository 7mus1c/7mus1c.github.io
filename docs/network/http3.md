# HTTP与反向代理

## 什么是代理

代理可以理解为海外代购，代购就是一个代理。说白了就是一个替咱们代办事情的一个人。什么情况下需要代理？比如说在局域网内，只能访问网内的东西。想要访问网外是要受到限制的。想要访问外网就需要在外网和局域网之间架一个设备，需要通过这个设备来访问外网，这个设备就是代理。它叫代理服务器，它可以是一个软件也可以是一个设备。

工作流程：

1. 访问外网
2. 代理收到请求，进行拦截
3. 代理去帮着向外网进行请求
4. 外网的数据回来以后再传回给局域网内
5. 如果再次访问这个资源的话，代理可以直接去拿这个资源 这个时候代理就是有一个缓存的作用

在每个地区网络运营商都会有代理服务器，它主要用来做缓存用。公司里边代理一般限制上网用的，或者检测是访问的网络是否正常工作需要。（检测你是否上班摸鱼）

## 什么是反向代理

反向代理是把代理倒过来了，它也在局域网内的。只不过是让互联网向局域网内访问的。反向代理可以负责转发请求。比如说在一个机房内web服务器很多个上，如果服务器是网站域名都不一样，但是都绑定在一个IP地址上，那么这一个IP地址就是这个局域网的入口，然后请求过来，在TCP层面上通过IP来找到这个入口，在HTTP层面上是有域名的，然后反向代理拿到请求之后找到这个域名，看看域名在内网的机器上对应的机器是哪一个。它把这个请求转发到正确的机器上。

## 反向代理的用途

- 加密和SSL加速
  - web服务器可能是PHP的也可能是tomcat的也可能是nodejs的，这些服务器早期它是一种CPU密集型的，它对I/O的性能并不是很好，所以不能在这种服务器上不能加很多功能，比如说HTTPS配置到tomcat上，或者node上，他们除了要干活还要负责加解密，这就加重了服务器的压力
  - 这个时候就需要反向代理服务器去分担，在内网的时候数据加密要求并不高，主要是对外网怕是有窃听，所以把HTTPS配置在反向代理上，加密解密的压力都在反向代理服务器上了
- 负载均衡
  - 比如说网站流量相当大，一台服务器是承受不住的，加硬件成本非常高，性能的收益但是并不是很大，这个时候就需要把流量分摊到几台服务器上，这个时候分摊流量的活就需要反向代理来干，反向代理上有负载均衡算法，它内部是有权重的，可以优先使用哪台服务器
- 缓存静态内容
  - 可以缓存网页，css、js、图片等这些静态内容
  - 服务器在静态资源处理方便并不如反向代理速度快
- 压缩
  - HTTP头上可以放到这里压缩
- 减速上传
  - 本质是流量控制，比如大文件上传把整个带宽占满了，肯定不能行
- 安全
  - 反向代理服务器是所有服务器的入口，如果受到入侵必须先攻破反向代理才能去攻击其他服务器
  - 攻击反向代理的时候就有一个缓冲的时间可以做反应
- 外网发布
  - 一台服务器上有两个web服务，端口肯定不一样，但是对向外提供服务必须是90端口，他们不能都设置成80端口，所以整个时候就需要反向代理统一用80端口对外服务，流向不同网站的请求进行转发

## 都有哪些反向代理服务器

| 软件名称  | 性能                                           | 功能                                                                             | 过滤规则配置                                                     |
| :-------- | :--------------------------------------------- | :------------------------------------------------------------------------------- | :--------------------------------------------------------------- |
| Squid     | 不能多核是硬伤； 磁盘缓存容量有优势； 性能中等 | 多； 支持ACL角色控制； 支持ICP缓存协议                                           | 支持外部文件读取及热加载； 支持热启动                            |
| Varnish   | 多核支持； 内存缓存； 性能强                   | 够用； 支持集群，但不支持ICP集群； 支持后端存活检查                              | 不支持外部文件读取； 需要转义； 支持热启动                       |
| Nginx     | 多核支持； 支持代理插件； 性能较强             | 多； 支持集群，但不支持ICP集群； 支持后端存活检查； 通过插件可以充当多角色服务器 | 不支持外部文件读取； 需要转义； 支持热启动                       |
| Apache TS | 多核支持； 磁盘/内存缓存； 性能强              | 够用； 支持后端存活检查； 支持ICP协议，Cluster不稳定； 支持插件开发；            | 支持外部规则文件读取及热加载； 支持热启动                        |
| HAProxy   | 多核支持； 无缓存； 支持HTTP头部解析； 性能强  | 少，只专注HTTP头部解析和转发功能； 支持ACL角色控制； 支持后端存活检查            | 支持外部规则文件读取及热加载； 支持热启动； 支持会话粘滞和长连接 |

最常用的就是 Nginx 服务器了。
